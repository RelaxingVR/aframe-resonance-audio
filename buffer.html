<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Buffer Test</title>
    <script src="music-tempo.min.js"></script>
  </head>
  <body>
    <button type="button" name="button">Play</button>
    <h1 id='curTime'>Context Time: 0</h1>
    <h1 id='audTime'>Audio Time: 0</h1>
    <audio id="song" src='/assets/audio/love.mp3'></audio>
    <script type="text/javascript">

      var AudioContext = window.AudioContext || window.webkitAudioContext;
      var ctxTimeEl = document.querySelector('#curTime')
      var audTimeEl = document.querySelector('#audTime')
      var actx = new AudioContext(),
      src = "/assets/audio/love.mp3",
      audioData, srcNode, timeDisplay, audioEl, beatIdx = 0, mt;  // global so we can access them from handlers



      // Load some audio (CORS need to be allowed or we won't be able to decode the data)
      fetch(src, {mode: "cors"}).then(function(resp) {return resp.arrayBuffer()}).then(decode);

      // Decode the audio file, then start the show
      function decode(buffer) {
        ctxTimeEl.innerHTML = "Context Time: Loading..."
        audTimeEl.innerHTML = "Tolerance Delta Time: Loading..."
        actx.decodeAudioData(buffer, initAudio);
      }

      function initAudio(abuffer) {
        audioEl = document.querySelector("audio")
        srcNode = actx.createMediaElementSource(audioEl)
        srcNode.connect(actx.destination);

        //Get Tempo data
        var audioArr = []
        if (abuffer.numberOfChannels == 2) {
          var channel1Data = abuffer.getChannelData(0);
          var channel2Data = abuffer.getChannelData(1);
          var length = channel1Data.length;
          for (var i = 0; i < length; i++) {
            audioArr[i] = (channel1Data[i] + channel2Data[i]) / 2;
          }
        } else {
          audioArr = buffer.getChannelData(0);
        }
        mt = new MusicTempo(audioArr);
        ctxTimeEl.innerHTML = "Context Time: Loaded"
        audTimeEl.innerHTML = "Tolerance Delta Time: Loaded"

        // if (actx.state "running") {
        //   audioEl.play()
        // }
        // console.log(mt);
        // console.log(srcNode);
        // displayTime()
        // runBeep()
      }

      document.querySelector("button").onmousedown = () => {
        if (actx.state === "suspended") {
          actx.resume()
        }
      }

      // Simple example control
      document.querySelector("button").onmouseup = function() {
        if (this.innerText === "Pause") {
          actx.suspend()
          this.innerText = "Play";
          clearInterval(timeDisplay)

        }
        else {
          if (!actx.state === "running") {
            actx.resume()
          }
          if (audioEl.paused) {
            audioEl.play()
          }
          this.innerText = "Pause";
          displayTime()
          runBeep()
        }
      };

      function displayTime () {
        if (actx) {
          timeDisplay = setInterval(()=>{
            ctxTimeEl.innerHTML = "Context Time: " + actx.currentTime
            audTimeEl.innerHTML = "Tolerance Delta Time: " + Math.abs(audioEl.currentTime - mt.beats[beatIdx])
          }, 100)
        }
      }

      function runBeep () {
        setInterval(()=>{
          if (Math.abs(audioEl.currentTime - mt.beats[beatIdx]) < .02) {
            var beep = actx.createOscillator()
            var gain = actx.createGain()
            gain.gain.value = .1
            beep.type = "square"
            beep.connect(gain);
            gain.connect(actx.destination)
            beep.start(actx.currentTime)
            beep.stop(actx.currentTime + .04)
            beatIdx ++
          }
        }, 10)
      }


    </script>
  </body>
</html>
